<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/app.html}"
>
  <head>
    <meta charset="UTF-8" />
    <title>Estadísticas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>

  <body>
    <section layout:fragment="content">
      <div class="container-fluid">
        <!-- titulo principal -->
        <h2 class="page-title text-center mb-4">Estadísticas de Ingresos</h2>

        <!-- boton descargar-->
        <!--  <div class="text-center mb-4">
          <button class="btn btn-danger" onclick="downloadPDF()">
            <i class="bi bi-arrow-down-circle"></i> Descargar PDF
          </button>
        </div> -->

        <!-- Filtros y descarga -->
        <div class="text-center mb-4">
          <select
            id="tipoEstadistica"
            class="form-control input-small d-inline-block w-auto"
          >
            <option value="dia">Ingresos por Día</option>
            <option value="mes">Ingresos por Mes</option>
            <option value="anio">Ingresos por Año</option>
            <option value="empresa">Ingresos por Empresa</option>
          </select>

          <button class="btn-delete ms-2" onclick="descargarPDFServidor()">
            <i class="bi bi-filetype-pdf"></i> Descargar PDF
          </button>
        </div>

        <!-- Gráfico por día -->
        <div class="card-custom mb-4">
          <div class="card-header-custom">Ingresos por Día</div>
          <div class="card-body">
            <canvas id="dayChart"></canvas>
          </div>
        </div>

        <!-- Gráfico por mes -->
        <div class="card-custom mb-4">
          <div class="card-header-custom">Ingresos por Mes</div>
          <div class="card-body">
            <canvas id="monthChart"></canvas>
          </div>
        </div>

        <!-- Gráfico por año -->
        <div class="card-custom mb-4">
          <div class="card-header-custom">Ingresos por Año</div>
          <div class="card-body">
            <canvas id="yearChart"></canvas>
          </div>
        </div>

        <!-- Gráfico por empresa -->
        <div class="card-custom mb-4">
          <div class="card-header-custom">Ingresos por Empresa</div>
          <div class="card-body">
            <canvas id="empresaChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Variables Thymeleaf -->
      <script th:inline="javascript">
        /*<![CDATA[*/
        const dayLabels = /*[[${dayLabels}]]*/ [];
        const dayData = /*[[${dayData}]]*/ [];

        const monthLabels = /*[[${monthLabels}]]*/ [];
        const monthData = /*[[${monthData}]]*/ [];

        const yearLabels = /*[[${yearLabels}]]*/ [];
        const yearData = /*[[${yearData}]]*/ [];

        const empresaLabels = /*[[${empresaLabels}]]*/ [];
        const empresaData = /*[[${empresaData}]]*/ [];
        /*]]>*/
      </script>

      <script>
        function safeChart(ctx, cfg) {
          try {
            return new Chart(ctx, cfg);
          } catch (e) {
            console.error("Chart error", e);
          }
        }

        safeChart(document.getElementById("dayChart"), {
          type: "line",
          data: {
            labels: dayLabels,
            datasets: [
              {
                label: "Ingresos por Día",
                data: dayData,
                borderColor: "#3a82f7",
                backgroundColor: "rgba(58,130,247,0.1)",
                fill: true,
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });

        safeChart(document.getElementById("monthChart"), {
          type: "bar",
          data: {
            labels: monthLabels,
            datasets: [
              {
                label: "Ingresos por Mes",
                data: monthData,
                backgroundColor: "#28a745",
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });

        safeChart(document.getElementById("yearChart"), {
          type: "bar",
          data: {
            labels: yearLabels,
            datasets: [
              {
                label: "Ingresos por Año",
                data: yearData,
                backgroundColor: "#17a2b8",
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });

        safeChart(document.getElementById("empresaChart"), {
          type: "pie",
          data: {
            labels: empresaLabels,
            datasets: [
              {
                label: "Ingresos por Empresa",
                data: empresaData,
                backgroundColor: [
                  "#f6c23e",
                  "#e74a3b",
                  "#858796",
                  "#20c9a6",
                  "#3a82f7",
                ],
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });
      </script>

      <!-- Librerías para exportar a PDF -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

      <!-- para descargar PDF -->
      <script>
        async function downloadPDF() {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p", "mm", "a4");

          const content = document.querySelector(".container-fluid");

          await html2canvas(content, { scale: 2 }).then((canvas) => {
            const imgData = canvas.toDataURL("image/png");
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
            pdf.save("estadisticas.pdf");
          });
        }

        function descargarPDFServidor() {
          const tipo = document.getElementById("tipoEstadistica").value;
          window.location.href = `/estadisticas/pdf?tipo=${tipo}`;
        }
      </script>
    </section>
  </body>
</html>
